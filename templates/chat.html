<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Programming Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <!-- Add Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <style>
      .main-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        height: calc(100vh - 2rem);
        padding: 1rem;
        overflow: hidden;
      }

      .left-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        overflow: hidden;
      }

      .right-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 1rem;
        overflow: hidden;
      }

      .chat-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 transparent;
      }

      .chat-container::-webkit-scrollbar {
        width: 8px;
      }

      .chat-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-container::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 4px;
      }

      .code-editor {
        height: 60%;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .code-editor .monaco-editor {
        height: 100% !important;
      }

      .output-container {
        height: 40%;
        background: #1e1e1e;
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        font-family: 'Consolas', 'Monaco', monospace;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #4b5563 transparent;
      }

      .output-container::-webkit-scrollbar {
        width: 8px;
      }

      .output-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .output-container::-webkit-scrollbar-thumb {
        background-color: #4b5563;
        border-radius: 4px;
      }

      .output-container pre {
        margin: 0;
        font-family: inherit;
        color: inherit;
      }

      .output-container .error {
        color: #ef4444;
      }

      .message {
        margin: 10px;
        padding: 10px;
        border-radius: 10px;
        max-width: 80%;
      }

      .user-message {
        background-color: #4f46e5;
        color: white;
        margin-left: auto;
      }

      .bot-message {
        background-color: #f3f4f6;
        color: #1f2937;
      }

      /* Markdown styles */
      .bot-message pre {
        background-color: #f6f8fa;
        border-radius: 6px;
        padding: 16px;
        overflow-x: auto;
        margin: 8px 0;
        position: relative;
      }

      .code-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .bot-message pre:hover .code-actions {
        opacity: 1;
      }

      .code-button {
        background-color: #4f46e5;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .code-button:hover {
        background-color: #4338ca;
      }

      .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        background-color: #10b981;
        color: white;
        border-radius: 6px;
        font-size: 14px;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s, transform 0.3s;
        z-index: 1000;
      }

      .notification.show {
        opacity: 1;
        transform: translateY(0);
      }

      .use-code-button {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: #4f46e5;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .bot-message pre:hover .use-code-button {
        opacity: 1;
      }

      .use-code-button:hover {
        background-color: #4338ca;
      }

      .bot-message code {
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas,
          Liberation Mono, monospace;
        font-size: 0.9em;
        padding: 0.2em 0.4em;
        background-color: rgba(175, 184, 193, 0.2);
        border-radius: 6px;
      }

      .bot-message pre code {
        background-color: transparent;
        padding: 0;
      }

      .controls {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem;
        border-top: 1px solid #e2e8f0;
      }

      .button {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .run-button {
        background-color: #22c55e;
        color: white;
      }

      .run-button:hover {
        background-color: #16a34a;
      }

      .clear-button {
        background-color: #ef4444;
        color: white;
      }

      .clear-button:hover {
        background-color: #dc2626;
      }

      .message-bubble {
        max-width: 80%;
        margin: 8px;
        padding: 12px;
        border-radius: 12px;
        line-height: 1.5;
        overflow-wrap: break-word;
        word-wrap: break-word;
        word-break: break-word;
      }

      .message-bubble pre {
        background-color: #1e1e1e;
        border-radius: 6px;
        padding: 12px;
        margin: 8px 0;
        overflow-x: auto;
        max-width: 100%;
        scrollbar-width: thin;
        scrollbar-color: #4b5563 transparent;
      }

      .message-bubble pre::-webkit-scrollbar {
        height: 8px;
      }

      .message-bubble pre::-webkit-scrollbar-track {
        background: transparent;
      }

      .message-bubble pre::-webkit-scrollbar-thumb {
        background-color: #4b5563;
        border-radius: 4px;
      }

      .message-bubble code {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9em;
        padding: 0.2em 0.4em;
        border-radius: 4px;
      }

      .message-bubble pre code {
        padding: 0;
      }

      .thinking {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        color: #6b7280;
      }

      .thinking-dots {
        display: flex;
        gap: 4px;
      }

      .dot {
        width: 8px;
        height: 8px;
        background-color: #6b7280;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      /* Suggested prompts styles */
      .suggested-prompts {
        margin-bottom: 12px;
      }

      .suggested-prompts h3 {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .prompt-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .prompt-item {
        background-color: #f3f4f6;
        color: #4f46e5;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #e5e7eb;
      }

      .prompt-item:hover {
        background-color: #4f46e5;
        color: white;
        border-color: #4f46e5;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto">
      <h1 class="text-3xl font-bold text-center my-4">AI Programming Tutor</h1>

      <div class="main-container">
        <!-- Left Panel: Chat -->
        <div class="left-panel">
          <div id="chat-messages" class="chat-container">
            <!-- Messages will be added here -->
          </div>

          <div class="border-t border-gray-200 p-4">
            <div class="suggested-prompts">
              <h3>G·ª£i √Ω c√¢u h·ªèi:</h3>
              <div class="prompt-list">
                <button
                  class="prompt-item"
                  onclick="usePrompt('Cho t√¥i b√†i t·∫≠p b·∫•t k√¨')"
                >
                  Cho t√¥i b√†i t·∫≠p b·∫•t k√¨
                </button>
                <button
                  class="prompt-item"
                  onclick="usePrompt('Gi·∫£i th√≠ch v·ªÅ thu·∫≠t to√°n s·∫Øp x·∫øp')"
                >
                  Gi·∫£i th√≠ch v·ªÅ thu·∫≠t to√°n s·∫Øp x·∫øp
                </button>
                <button
                  class="prompt-item"
                  onclick="usePrompt('H∆∞·ªõng d·∫´n t√¥i v·ªÅ l·∫≠p tr√¨nh h∆∞·ªõng ƒë·ªëi t∆∞·ª£ng')"
                >
                  H∆∞·ªõng d·∫´n v·ªÅ OOP
                </button>
              </div>
            </div>
            <form id="chat-form" class="space-y-4">
              <div>
                <label
                  for="message-input"
                  class="block text-sm font-medium text-gray-700"
                >
                  Tin nh·∫Øn c·ªßa b·∫°n:
                </label>
                <textarea
                  id="message-input"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 min-h-[80px] p-2"
                  placeholder="Nh·∫≠p c√¢u h·ªèi ho·∫∑c y√™u c·∫ßu c·ªßa b·∫°n..."
                ></textarea>
              </div>
              <button
                type="submit"
                class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors"
              >
                G·ª≠i
              </button>
            </form>
          </div>
        </div>

        <!-- Right Panel: Code Editor and Output -->
        <div class="right-panel">
          <div class="code-editor" id="code-editor"></div>
          <div class="output-container" id="output-container">
            <div id="output"></div>
          </div>
          <div class="controls">
            <button id="run-code" class="button run-button">Ch·∫°y Code</button>
            <button id="clear-output" class="button clear-button">
              X√≥a Output
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const messageContainer = document.getElementById('chat-messages');
      const chatForm = document.getElementById('chat-form');
      const messageInput = document.getElementById('message-input');
      const outputContainer = document.getElementById('output');
      const runButton = document.getElementById('run-code');
      const clearButton = document.getElementById('clear-output');
      let chatHistory = [];
      let lastTerminalOutput = '';

      // Initialize Monaco Editor
      require.config({
        paths: {
          vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs',
        },
      });
      require(['vs/editor/editor.main'], function () {
        window.editor = monaco.editor.create(
          document.getElementById('code-editor'),
          {
            value: '# Vi·∫øt code Python c·ªßa b·∫°n ·ªü ƒë√¢y\n',
            language: 'python',
            theme: 'vs-dark',
            minimap: { enabled: false },
            automaticLayout: true,
          }
        );
      });

      // Initialize marked with syntax highlighting
      marked.setOptions({
        highlight: function (code, lang) {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
          }
          return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true,
      });

      // Add prompt suggestion function
      function usePrompt(prompt) {
        const messageInput = document.getElementById('message-input');
        messageInput.value = prompt;
        messageInput.focus();
      }

      // Welcome message
      const welcomeMessage = `Xin ch√†o! M√¨nh l√† AI Programming Tutor. M√¨nh c√≥ th·ªÉ gi√∫p b·∫°n:

- Review v√† ph√¢n t√≠ch code
- Gi·∫£i th√≠ch c√°c kh√°i ni·ªám l·∫≠p tr√¨nh
- S·ª≠a l·ªói v√† t·ªëi ∆∞u code
- H∆∞·ªõng d·∫´n gi·∫£i quy·∫øt b√†i t·∫≠p
- Chia s·∫ª best practices

B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu b·∫±ng c√°ch ch·ªçn m·ªôt trong c√°c g·ª£i √Ω c√¢u h·ªèi ph√≠a d∆∞·ªõi ho·∫∑c t·ª± ƒë·∫∑t c√¢u h·ªèi c·ªßa m√¨nh.`;

      function createThinkingIndicator() {
        const thinking = document.createElement('div');
        thinking.className = 'thinking';
        thinking.innerHTML = `
          <span>ƒêang suy nghƒ©</span>
          <div class="thinking-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
        `;
        return thinking;
      }

      // Add notification function
      function showNotification(message) {
        // Remove existing notification if any
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
          existingNotification.remove();
        }

        // Create new notification
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);

        // Show notification
        setTimeout(() => notification.classList.add('show'), 10);

        // Hide and remove notification after 3 seconds
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${
          isUser ? 'justify-end' : 'justify-start'
        }`;

        const messageBubble = document.createElement('div');
        messageBubble.className = `message-bubble ${
          isUser ? 'user-message' : 'bot-message'
        }`;

        // X·ª≠ l√Ω ƒë·ªãnh d·∫°ng agent output
        if (!isUser) {
          // T√°ch c√°c ph·∫ßn c·ªßa agent output v√† gi·ªØ nguy√™n kho·∫£ng tr·∫Øng ƒë·∫ßu d√≤ng
          const parts = content.split('\n');
          let formattedContent = '';
          let inCodeBlock = false;
          let currentBlock = [];

          parts.forEach((part, index) => {
            // Ki·ªÉm tra xem c√≥ ph·∫£i l√† ph·∫ßn b·∫Øt ƒë·∫ßu c·ªßa m·ªôt section m·ªõi kh√¥ng
            if (part.trim().startsWith('Thought:')) {
              // X·ª≠ l√Ω block tr∆∞·ªõc ƒë√≥ n·∫øu c√≥
              if (currentBlock.length > 0) {
                formattedContent += currentBlock.join('\n') + '\n\n';
                currentBlock = [];
              }
              inCodeBlock = false;
              formattedContent += `**üí≠ Suy nghƒ©:**\n${part
                .replace('Thought:', '')
                .trimLeft()}\n`;
            } else if (part.trim().startsWith('Action:')) {
              if (currentBlock.length > 0) {
                formattedContent += currentBlock.join('\n') + '\n\n';
                currentBlock = [];
              }
              inCodeBlock = false;
              formattedContent += `**üîß H√†nh ƒë·ªông:**\n${part
                .replace('Action:', '')
                .trimLeft()}\n`;
            } else if (part.trim().startsWith('Action Input:')) {
              if (currentBlock.length > 0) {
                formattedContent += currentBlock.join('\n') + '\n\n';
                currentBlock = [];
              }
              inCodeBlock = false;
              formattedContent += `**üì• Input:**\n${part
                .replace('Action Input:', '')
                .trimLeft()}\n`;
            } else if (part.trim().startsWith('Final Answer:')) {
              if (currentBlock.length > 0) {
                formattedContent += currentBlock.join('\n') + '\n\n';
                currentBlock = [];
              }
              inCodeBlock = false;
              formattedContent += `**üí° K·∫øt qu·∫£:**\n${part
                .replace('Final Answer:', '')
                .trimLeft()}\n`;
            } else {
              // Ki·ªÉm tra xem c√≥ ph·∫£i l√† code block kh√¥ng
              if (part.trim().startsWith('```')) {
                if (!inCodeBlock) {
                  // B·∫Øt ƒë·∫ßu code block m·ªõi
                  inCodeBlock = true;
                  currentBlock = [part];
                } else {
                  // K·∫øt th√∫c code block
                  inCodeBlock = false;
                  currentBlock.push(part);
                  formattedContent += currentBlock.join('\n') + '\n\n';
                  currentBlock = [];
                }
              } else if (inCodeBlock) {
                // Th√™m d√≤ng v√†o code block hi·ªán t·∫°i, gi·ªØ nguy√™n kho·∫£ng tr·∫Øng
                currentBlock.push(part);
              } else {
                // D√≤ng b√¨nh th∆∞·ªùng, th√™m v√†o block hi·ªán t·∫°i
                formattedContent += part + '\n';
              }
            }
          });

          // X·ª≠ l√Ω block cu·ªëi c√πng n·∫øu c√≥
          if (currentBlock.length > 0) {
            formattedContent += currentBlock.join('\n') + '\n';
          }

          content = formattedContent.trim();
        }

        // Convert markdown to HTML
        messageBubble.innerHTML = marked.parse(content);

        // Apply syntax highlighting to code blocks
        messageBubble.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightBlock(block);

          // Check if this is a copyable code block
          const preElement = block.parentElement;
          if (
            preElement &&
            block.className.includes('language-python:copyable')
          ) {
            // Create code actions container
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'code-actions';

            // Create "Replace Code" button
            const replaceButton = document.createElement('button');
            replaceButton.className = 'code-button';
            replaceButton.textContent = 'Thay th·∫ø code';
            replaceButton.onclick = () => {
              const code = block.textContent;
              if (window.editor) {
                window.editor.setValue(code);
                window.editor.focus();
                showNotification('ƒê√£ thay th·∫ø code trong editor');
              }
            };

            // Create "Insert Code" button
            const insertButton = document.createElement('button');
            insertButton.className = 'code-button';
            insertButton.textContent = 'Ch√®n code';
            insertButton.onclick = () => {
              const code = block.textContent;
              if (window.editor) {
                const position = window.editor.getPosition();
                const selection = window.editor.getSelection();

                if (selection && !selection.isEmpty()) {
                  // If there's a selection, replace it
                  window.editor.executeEdits('', [
                    {
                      range: selection,
                      text: code,
                      forceMoveMarkers: true,
                    },
                  ]);
                } else {
                  // Insert at cursor position
                  window.editor.executeEdits('', [
                    {
                      range: new monaco.Range(
                        position.lineNumber,
                        position.column,
                        position.lineNumber,
                        position.column
                      ),
                      text: code,
                      forceMoveMarkers: true,
                    },
                  ]);
                }
                window.editor.focus();
                showNotification('ƒê√£ ch√®n code v√†o v·ªã tr√≠ con tr·ªè');
              }
            };

            // Add buttons to actions container
            actionsDiv.appendChild(replaceButton);
            actionsDiv.appendChild(insertButton);

            // Add actions to pre element
            preElement.style.position = 'relative';
            preElement.appendChild(actionsDiv);
          }
        });

        messageDiv.appendChild(messageBubble);
        messageContainer.appendChild(messageDiv);
        messageContainer.scrollTop = messageContainer.scrollHeight;

        // Update chat history
        chatHistory.push({
          role: isUser ? 'user' : 'assistant',
          content: content,
        });
      }

      // Add welcome message on load
      addMessage(welcomeMessage, false);

      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, true);
        messageInput.value = '';

        // Add thinking indicator
        const thinking = createThinkingIndicator();
        messageContainer.appendChild(thinking);
        messageContainer.scrollTop = messageContainer.scrollHeight;

        try {
          const response = await fetch('/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: message,
              code: window.editor ? window.editor.getValue() : '',
              history: chatHistory,
              terminal_output: lastTerminalOutput,
            }),
          });

          // Remove thinking indicator
          thinking.remove();

          const data = await response.json();
          addMessage(data.response);
        } catch (error) {
          // Remove thinking indicator
          thinking.remove();

          console.error('Error:', error);
          addMessage('Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n.');
        }
      });

      // Run code button handler
      runButton.addEventListener('click', async () => {
        const code = window.editor.getValue();
        try {
          // Clear previous output
          outputContainer.innerHTML = '';

          const response = await fetch('/run_code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code }),
          });

          const data = await response.json();
          // Replace newlines with <br> and preserve whitespace
          const formattedOutput = data.output.replace(/\n/g, '<br>');
          outputContainer.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word;">${formattedOutput}</pre>`;
          lastTerminalOutput = data.output;
        } catch (error) {
          console.error('Error:', error);
          const errorOutput = `<pre class="text-red-500">Error running code: ${error.message}</pre>`;
          outputContainer.innerHTML = errorOutput;
          lastTerminalOutput = `Error running code: ${error.message}`;
        }
      });

      // Clear output button handler
      clearButton.addEventListener('click', () => {
        outputContainer.innerHTML = '';
      });

      // Focus input on load
      messageInput.focus();
    </script>
  </body>
</html>
