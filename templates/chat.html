<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Programming Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <!-- Add Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <style>
      .main-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        height: calc(100vh - 2rem);
        padding: 1rem;
        overflow: hidden;
      }

      .left-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        overflow: hidden;
      }

      .right-panel {
        display: flex;
        flex-direction: column;
        height: 100%;
        gap: 1rem;
        overflow: hidden;
      }

      .chat-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 transparent;
      }

      .chat-container::-webkit-scrollbar {
        width: 8px;
      }

      .chat-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .chat-container::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 4px;
      }

      .code-editor {
        height: 60%;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .code-editor .monaco-editor {
        height: 100% !important;
      }

      .output-container {
        height: 40%;
        background: #1e1e1e;
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        font-family: 'Consolas', 'Monaco', monospace;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #4b5563 transparent;
      }

      .output-container::-webkit-scrollbar {
        width: 8px;
      }

      .output-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .output-container::-webkit-scrollbar-thumb {
        background-color: #4b5563;
        border-radius: 4px;
      }

      .output-container pre {
        margin: 0;
        font-family: inherit;
        color: inherit;
      }

      .output-container .error {
        color: #ef4444;
      }

      .message {
        margin: 10px;
        padding: 10px;
        border-radius: 10px;
        max-width: 80%;
      }

      .user-message {
        background-color: #4f46e5;
        color: white;
        margin-left: auto;
      }

      .bot-message {
        background-color: #f3f4f6;
        color: #1f2937;
      }

      /* Markdown styles */
      .bot-message pre {
        background-color: #f6f8fa;
        border-radius: 6px;
        padding: 16px;
        overflow-x: auto;
        margin: 8px 0;
      }

      .bot-message code {
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas,
          Liberation Mono, monospace;
        font-size: 0.9em;
        padding: 0.2em 0.4em;
        background-color: rgba(175, 184, 193, 0.2);
        border-radius: 6px;
      }

      .bot-message pre code {
        background-color: transparent;
        padding: 0;
      }

      .controls {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem;
        border-top: 1px solid #e2e8f0;
      }

      .button {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .run-button {
        background-color: #22c55e;
        color: white;
      }

      .run-button:hover {
        background-color: #16a34a;
      }

      .clear-button {
        background-color: #ef4444;
        color: white;
      }

      .clear-button:hover {
        background-color: #dc2626;
      }

      .message-bubble {
        max-width: 80%;
        margin: 8px;
        padding: 12px;
        border-radius: 12px;
        line-height: 1.5;
        overflow-wrap: break-word;
        word-wrap: break-word;
        word-break: break-word;
      }

      .message-bubble pre {
        background-color: #1e1e1e;
        border-radius: 6px;
        padding: 12px;
        margin: 8px 0;
        overflow-x: auto;
        max-width: 100%;
        scrollbar-width: thin;
        scrollbar-color: #4b5563 transparent;
      }

      .message-bubble pre::-webkit-scrollbar {
        height: 8px;
      }

      .message-bubble pre::-webkit-scrollbar-track {
        background: transparent;
      }

      .message-bubble pre::-webkit-scrollbar-thumb {
        background-color: #4b5563;
        border-radius: 4px;
      }

      .message-bubble code {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9em;
        padding: 0.2em 0.4em;
        border-radius: 4px;
      }

      .message-bubble pre code {
        padding: 0;
      }

      .thinking {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        color: #6b7280;
      }

      .thinking-dots {
        display: flex;
        gap: 4px;
      }

      .dot {
        width: 8px;
        height: 8px;
        background-color: #6b7280;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }

      .dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto">
      <h1 class="text-3xl font-bold text-center my-4">AI Programming Tutor</h1>

      <div class="main-container">
        <!-- Left Panel: Chat -->
        <div class="left-panel">
          <div id="chat-messages" class="chat-container">
            <!-- Messages will be added here -->
          </div>

          <div class="border-t border-gray-200 p-4">
            <form id="chat-form" class="space-y-4">
              <div>
                <label
                  for="message-input"
                  class="block text-sm font-medium text-gray-700"
                >
                  Tin nhắn của bạn:
                </label>
                <textarea
                  id="message-input"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 min-h-[80px] p-2"
                  placeholder="Nhập câu hỏi hoặc yêu cầu của bạn..."
                ></textarea>
              </div>
              <button
                type="submit"
                class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors"
              >
                Gửi
              </button>
            </form>
          </div>
        </div>

        <!-- Right Panel: Code Editor and Output -->
        <div class="right-panel">
          <div class="code-editor" id="code-editor"></div>
          <div class="output-container" id="output-container">
            <div id="output"></div>
          </div>
          <div class="controls">
            <button id="run-code" class="button run-button">Chạy Code</button>
            <button id="clear-output" class="button clear-button">
              Xóa Output
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const messageContainer = document.getElementById('chat-messages');
      const chatForm = document.getElementById('chat-form');
      const messageInput = document.getElementById('message-input');
      const outputContainer = document.getElementById('output');
      const runButton = document.getElementById('run-code');
      const clearButton = document.getElementById('clear-output');
      let chatHistory = [];

      // Initialize Monaco Editor
      require.config({
        paths: {
          vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs',
        },
      });
      require(['vs/editor/editor.main'], function () {
        window.editor = monaco.editor.create(
          document.getElementById('code-editor'),
          {
            value: '# Viết code Python của bạn ở đây\n',
            language: 'python',
            theme: 'vs-dark',
            minimap: { enabled: false },
            automaticLayout: true,
          }
        );
      });

      // Initialize marked with syntax highlighting
      marked.setOptions({
        highlight: function (code, lang) {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
          }
          return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true,
      });

      // Welcome message
      const welcomeMessage = `Xin chào! Mình là AI Programming Tutor. Mình có thể giúp bạn:

- Review và phân tích code
- Giải thích các khái niệm lập trình
- Sửa lỗi và tối ưu code
- Hướng dẫn giải quyết bài tập
- Chia sẻ best practices

Hãy đặt câu hỏi hoặc chia sẻ code của bạn để bắt đầu nhé!`;

      function createThinkingIndicator() {
        const thinking = document.createElement('div');
        thinking.className = 'thinking';
        thinking.innerHTML = `
          <span>Đang suy nghĩ</span>
          <div class="thinking-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
        `;
        return thinking;
      }

      function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${
          isUser ? 'justify-end' : 'justify-start'
        }`;

        const messageBubble = document.createElement('div');
        messageBubble.className = `message-bubble ${
          isUser ? 'user-message' : 'bot-message'
        }`;

        // Convert markdown to HTML
        messageBubble.innerHTML = marked.parse(content);

        // Apply syntax highlighting to code blocks
        messageBubble.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightBlock(block);
        });

        messageDiv.appendChild(messageBubble);
        messageContainer.appendChild(messageDiv);
        messageContainer.scrollTop = messageContainer.scrollHeight;

        // Update chat history
        chatHistory.push({
          role: isUser ? 'user' : 'assistant',
          content: content,
        });
      }

      // Add welcome message on load
      addMessage(welcomeMessage, false);

      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, true);
        messageInput.value = '';

        // Add thinking indicator
        const thinking = createThinkingIndicator();
        messageContainer.appendChild(thinking);
        messageContainer.scrollTop = messageContainer.scrollHeight;

        try {
          const response = await fetch('/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              message: message,
              code: window.editor ? window.editor.getValue() : '',
              history: JSON.stringify(chatHistory),
            }),
          });

          // Remove thinking indicator
          thinking.remove();

          const data = await response.json();
          addMessage(data.response);
        } catch (error) {
          // Remove thinking indicator
          thinking.remove();

          console.error('Error:', error);
          addMessage('Xin lỗi, đã có lỗi xảy ra khi xử lý yêu cầu của bạn.');
        }
      });

      // Run code button handler
      runButton.addEventListener('click', async () => {
        const code = window.editor.getValue();
        try {
          // Clear previous output
          outputContainer.innerHTML = '';

          const response = await fetch('/run_code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code }),
          });

          const data = await response.json();
          // Replace newlines with <br> and preserve whitespace
          const formattedOutput = data.output.replace(/\n/g, '<br>');
          outputContainer.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word;">${formattedOutput}</pre>`;
        } catch (error) {
          console.error('Error:', error);
          outputContainer.innerHTML = `<pre class="text-red-500">Error running code: ${error.message}</pre>`;
        }
      });

      // Clear output button handler
      clearButton.addEventListener('click', () => {
        outputContainer.innerHTML = '';
      });

      // Focus input on load
      messageInput.focus();
    </script>
  </body>
</html>
